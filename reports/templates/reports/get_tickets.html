<script>
i=0;
nextPage();

function prevPage() {
    if(i>1){
        i = i-1;
        getPage(i);
    }
}

function nextPage() {
    i = i+1;
    getPage(i);
}

function getPage(page) {

    $.getJSON("tickets?page="+page, function(data) {
                        console.log("got it");
                        handleData(data);
                    });
}

function failData(result) {
    console.log("failed");
    console.log(result);
    }
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
function handleData(result) {
            $("#table-data").empty();
            $("#page-list").empty();
            var tickets = result.tickets;
            tickets.forEach(ticket => {
                const tr = document.createElement("tr");
                let td = document.createElement("td");
                td.innerHTML=ticket.fecha;
                tr.appendChild(td);
                td = document.createElement("td");
                td.innerHTML=ticket.concepto;
                tr.appendChild(td);
                td = document.createElement("td");
                td.innerHTML=ticket.importe;
                tr.appendChild(td);

                td = document.createElement("td");
                td.innerHTML=ticket.saldo;
                tr.appendChild(td);

                td = document.createElement("td");
                td.innerHTML=ticket.moneda.key;
                tr.appendChild(td);

                const select = document.createElement("select");
                select.name = "categoria"

                result.categorias.forEach((categoria, i) =>{
                    let option = document.createElement("option");
                    option.text = categoria;
                    option.value = i+1;
                    if(ticket.categoria.name == categoria){
                        option.selected='selected';
                        }
                    select.add(option);
                });
                select.addEventListener('change', (event) => {
                    var xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function() {};
                    csrftoken = getCookie('csrftoken');
                    xhr.open('PUT', '/view/categorizar?ticket_id='+ticket.id+'&categoria_id='+event.target.value);
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    var data = {ticket_id: ticket.id, categoria_id: event.target.value};
                    xhr.send();
                });
                td = document.createElement("td");
                const div = document.createElement("div");
                div.className="select";
                div.appendChild(select);
                td.appendChild(div);
                tr.appendChild(td);
                document.getElementById("table-data").appendChild(tr);
            });
            var pages=result.pages;
            pages.forEach(page=>{
                const a = document.createElement("a");
                a.className = "pagination-link";
                a.innerHTML = page;
                a.onclick = function() {
                    getPage(page);
                }
                if(result.page_number == page){
                    a.classList.add('is-current');
                }
                document.getElementById("page-list").appendChild(a);
                });
    }
</script>